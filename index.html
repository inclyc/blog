<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"inclyc.cn","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.13.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="inclyc">
<meta property="og:url" content="http://inclyc.cn/index.html">
<meta property="og:site_name" content="inclyc">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="inclyc">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://inclyc.cn/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>inclyc</title>
  






  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">inclyc</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">echo 'compiler' | tee OS</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">inclyc</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/11/27/Compiler/vectorizer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/27/Compiler/vectorizer/" class="post-title-link" itemprop="url">SIMD，向量机与自动向量化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-11-28 00:40:37" itemprop="dateCreated datePublished" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Compiler/" itemprop="url" rel="index"><span itemprop="name">Compiler</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="并行化的需求">并行化的需求</h1>
<h2 id="moore-定律的终结">Moore 定律的终结</h2>
<p>集成电路上可容纳的晶体管数目，约每隔两年便会增加一倍。曾经我们可以非常简单地提高单核的性能来提高计算机的运行效率，然而，现在这一美好的想法已经结束了。由于功耗墙的存在，如今，CPU单核性能已经很难提升，CPU频率已经早已脱离早期指数性发展曲线。</p>
<p><img src="/images/moore.jpeg" alt="Moore's Law" style="width:60%;"/></p>
<h2 id="并行化">并行化</h2>
<p>提高计算机性能的方法，是并行化。让多个CPU，多个核心并行地处理问题，是提高性能的最佳方法。目前，几乎所有的超级计算机都以多核、并行、相关的方向入手，进行性能调优。</p>
<p><img src="/images/dual_core.png" alt="Dual Core Cache Design" style="width:30%;"/></p>
<h1 id="并行的手段">并行的手段</h1>
<h2 id="gpgpu---异构计算">GPGPU - 异构计算</h2>
<p>显卡(GPU)包含大量的核心来支持高度并行化的计算，最开始的在显卡上的编程是很困难的，随着时代的发展显卡的计算能力越来越不容小觑。通用计算显卡(GPGPU)也开始包含在编译优化的领域。AI模型在大型服务器集群上完成训练，要想投入实践就必须要把他编译到真正的体系结构上运行。</p>
<p><img src="/images/torch-mlir.png" alt="Torch-MLIR" style="width:60%;"/></p>
<p>异构计算最复杂的问题在于，多个层面的IR包含可能的信息丢失，如何把IR紧密结合在一起，并完成相应的编译优化？</p>
<p>例如，你容易知道一个矩阵求两次转置恒等 <span class="math inline">\(\left(A^T\right)^T = A\)</span> ，但如果矩阵转置已经被下降(lowering)到三地址码，甚至是更底层的指令，我们就丢失了矩阵实际上“求了两次转置”这么简单的优化条件。</p>
<p><a target="_blank" rel="noopener" href="https://mlir.llvm.org">MLIR</a>的出现有助于解决这个问题，但不是这篇文章的重点，可能我会在后续的文章里写相关问题。</p>
<h2 id="多核">多核</h2>
<p>为了实现并行化，我们可以给一个计算机加入多个核心。多核心的特点在于：</p>
<ul>
<li><p>他们拥有不同的寄存器</p></li>
<li><p>有不同的中断处理请求</p></li>
<li><p>一般由操作系统-对称多处理(SMP)调度</p></li>
</ul>
<p><img src="/images/smp.png" alt="Symmetric multiprocessing" style="width:60%;"/></p>
<p>不同的寄存器代表每个核心具有不同的状态。例如，他们可能拥有不同的PC指针指向不同的代码区段，这样便可同时执行编写好的多段代码。</p>
<h2 id="单核">单核</h2>
<h3 id="乱序执行-oooe">乱序执行 (OoOE)</h3>
<p>乱序执行(Out-of-Order Execution)是现代CPU最基本的一个并行手段。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">test</span><span class="params">(<span class="type">int</span> &amp;a,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="type">int</span> &amp;b,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="type">int</span> &amp;c,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="type">int</span> &amp;d)</span> </span>&#123;</span><br><span class="line">    a += b;</span><br><span class="line">    c += d;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段 C++ 代码被编译为如下所示的汇编。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lw      a1, 0(a1)</span><br><span class="line">lw      a4, 0(a0)</span><br><span class="line">addw    a1, a1, a4</span><br><span class="line">sw      a1, 0(a0)</span><br><span class="line">lw      a0, 0(a3)</span><br><span class="line">lw      a1, 0(a2)</span><br><span class="line">addw    a0, a0, a1</span><br><span class="line">sw      a0, 0(a2)</span><br></pre></td></tr></table></figure>
<h3 id="simd">SIMD</h3>
<p>OoOE在编程上由编译器全局指令调度器(Instruction Scheduler)优化。</p>
<p>单指令流多数据流(Single instruction, multiple data (SIMD))，提供了一种让我 们更好地进行向量计算的方式。</p>
<p><img src="/images/SIMD2.svg.png" alt="SIMD" style="width:40%;"/></p>
<h3 id="simd-的好处">SIMD 的好处</h3>
<p>通常情况下我们很难将串行代码转化为并行，为了设计并行算法通常需要改变原有的逻辑。</p>
<p><img src="/images/rgba.png" alt="RGBA" style="width:60%;"/></p>
<p>如图所示，在图形学中我们经常需要计算图像的颜色信息，而颜色在RGBA几个维度下的计算是可以向量化的。</p>
<h3 id="simd-的缺陷">SIMD 的缺陷</h3>
<blockquote>
<p>RISC-V Designers SIMD Instructions considered harmful. -- David Patterson</p>
</blockquote>
<p>一开始，SIMD被认为是实现并行化简单有效的方法。我们将64位寄存器和ALU划分为许多8, 16, 32位的块，然后并行地计算它们。用每条指令的操作码(opcode)提供数据宽度和操作。</p>
<p><strong>指令集膨胀</strong></p>
<p><code>IA-32</code>指令集已经从最开始的80多条指令增长到了现在的1400多条。<code>SSE</code>, <code>AVX</code>, 各种SIMD扩展和宽寄存器让指令集变得越来越复杂。</p>
<p><strong>尾循环</strong></p>
<p>SIMD 指令通常要求把数据完全加载到向量寄存器中，然后一次处理 <span class="math inline">\(n\)</span> 个数据。但不是所有的应用场合，需要处理的数据都能被 <span class="math inline">\(n\)</span> 整除，这就导致需要一个标量循环，完成向量循环的收尾工作，这个循环就被称为 <strong>尾循环</strong>。</p>
<h3 id="vector-vs-simd">Vector vs SIMD</h3>
<p>向量机与SIMD的真正区别在于，向量长度是否在机器码层面确定。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">memcpy_vec</span><span class="params">(<span class="type">void</span> *dst, <span class="type">void</span> *src, <span class="type">size_t</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="type">void</span> *save = dst;</span><br><span class="line">    <span class="comment">// 逐字节拷贝内存区域</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> vl; n &gt; <span class="number">0</span>; n -= vl, src += vl, dst += vl) &#123;</span><br><span class="line">        vl = <span class="built_in">vsetvl_e8m8</span>(n); <span class="comment">// 需要计算 n 个元素，由 CPU 计算 vl</span></span><br><span class="line">        <span class="type">vuint8m8_t</span> vec_src = <span class="built_in">vle8_v_u8m8</span>(src, vl); <span class="comment">// 从 src 中加载 vl 个元素</span></span><br><span class="line">        <span class="built_in">vse8_v_u8m8</span>(dst, vec_src, vl); <span class="comment">// 写入 vl 个元素到 dst</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> save;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个代码展示了 RISC-V 实现<code>memcpy</code>的矢量版本（“伪汇编”，用C表示）。 这个程序最关键的部分在于<code>vl</code>的设定，每次循环都加载<code>vl</code>个元素，而<code>vl</code>对于 RISC-V 而言是一个每次循环可变的量。</p>
<p>CPU可以自己适配要计算多少个元素，给出尽量多的一次计算的元素，然后再一起操作。</p>
<p><code>vl</code> 对于这段代码而言，是 “长度无关的”。对于传统的 SIMD 指令，我们需要用不同的指令，代表不同的向量长度，例如 <code>SSE</code> 通常加载 128 位，而 <code>AVX2</code> 通常加载 256 位。</p>
<p>这样做可以带来很多好处。首先，二进制程序便在支持不同矢量长度的 CPU 之间可以直接执行，而不需要重新编译（二进制兼容）。其次，SIMD 指令集通常需要内存对齐，尾循环等等不能很好向量化的部分，而可变向量长度 <code>vl</code> 的存在使得可以消除尾循环。</p>
<h1 id="自动向量化auto-vectorization">自动向量化(Auto-Vectorization)</h1>
<h2 id="可行性与好处">可行性与好处</h2>
<p>标量代码可以被自动向量化成含向量计算的代码。</p>
<p>事实上，大量的标量循环都可以被向量化 <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> * restrict A, <span class="type">int</span> * restrict B, <span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; n;i++)&#123;</span><br><span class="line">        A[i] += B[i];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="合法性">合法性</h2>
<p>数据依赖 &amp; Overlap (Alias Analysis)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i += <span class="number">1</span>) &#123;</span><br><span class="line">    a[i+<span class="number">1</span>] = b[i] + <span class="number">1</span>;  <span class="comment">// S1</span></span><br><span class="line">    b[i+<span class="number">1</span>] = a[i] + <span class="number">1</span>;  <span class="comment">// S2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/images/overlap.png" alt="Example of pointer overlapping" style="width:60%;"/></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>;i &lt; n;i++)</span><br><span class="line">    A[i] = A[i - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>;i &lt; n;i++)</span><br><span class="line">    A[i + <span class="number">1</span>] = B[i]; <span class="comment">// overlap?</span></span><br></pre></td></tr></table></figure>
<h2 id="收益">收益</h2>
<p>必然导致的程序大小增加 / 标量循环和向量循环的选择和跳转</p>
<p>数据对齐的代价，尾循环的代价，都是需要考虑的因素。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="type">i64</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">load</span> <span class="type">i64</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">load</span> <span class="type">i64</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">load</span> <span class="type">i64</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> &lt;<span class="number">4</span> <span class="keyword">x</span> <span class="type">i64</span>&gt;<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这个部分的代价计算在LLVM后端作为虚函数，由具体的<code>Target</code>给出估计。每个体系结构可能有不同的 SIMD 指令代价，但代价模型在优化层次是通用的</p>
<h2 id="transformation">Transformation</h2>
<p>下图展示了 LLVM Developer 2013 中，来自 Apple 的工程师给出的 LLVM 循环向量化工具。</p>
<p><img src="/images/trans.png" alt="LLVM Developer 2013 by Apple" style="width:60%;"/></p>
<h2 id="loop-vectorizer-enhancements">Loop Vectorizer Enhancements</h2>
<p>现代化向量指令集可以更好地完成向量长度选择。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">memcpy:</span><br><span class="line">    mv a3, a0 # Copy destination</span><br><span class="line">loop:</span><br><span class="line">    vsetvli t0, a2, e8, m8, ta, ma   # Vectors of 8b</span><br><span class="line">    vle8.v v0, (a1)                  # Load bytes</span><br><span class="line">    add a1, a1, t0                   # Bump pointer</span><br><span class="line">    sub a2, a2, t0                   # Decrement count</span><br><span class="line">    vse8.v v0, (a3)                  # Store bytes</span><br><span class="line">    add a3, a3, t0                   # Bump pointer</span><br><span class="line">    bnez a2, loop                    # Any more?</span><br><span class="line">    ret                              # Return</span><br></pre></td></tr></table></figure>
<h2 id="mask-predication">Mask &amp; Predication</h2>
<p>Predication (判定寄存器) 其实是来源于ARM SVE的一个东西</p>
<p>VP-based Loop Vectorizer 在 LLVM 中还没实现...</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/10/06/Misc/lazy_load_conda/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/06/Misc/lazy_load_conda/" class="post-title-link" itemprop="url">延迟加载conda环境</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-06 11:00:19" itemprop="dateCreated datePublished" datetime="2022-10-06T11:00:19+08:00">2022-10-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Misc/" itemprop="url" rel="index"><span itemprop="name">Misc</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言">前言</h1>
<p>每次开机或重启后，新开一个终端，总会有漫长的conda加载时间。</p>
<p><code>conda init</code> 会在你的shell中写入 <code>conda initialize</code> 相关的内容，保证 conda 环境被初始化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span></span><br><span class="line">__conda_setup=<span class="string">&quot;<span class="subst">$(<span class="string">&quot;<span class="variable">$__conda_prefix</span>/bin/conda&quot;</span> &#x27;shell.bash&#x27; &#x27;hook&#x27; 2&gt; /dev/null)</span>&quot;</span></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$__conda_setup</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$__conda_prefix</span>/etc/profile.d/conda.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        . <span class="string">&quot;<span class="variable">$__conda_prefix</span>/etc/profile.d/conda.sh&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$__conda_prefix</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> __conda_setup</span><br><span class="line"><span class="comment"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span></span><br></pre></td></tr></table></figure>
<p>然而，不知道为什么，这个东西会严重拖慢第一次打开终端时进入正常交互式shell的速度。</p>
<h1 id="解决方案">解决方案</h1>
<p>在这里我的解决方案是，添加一个延迟加载选项。我的日常环境中不是所有的终端都会用上conda，甚至大概率不用。所以按需要加载环境就非常重要。</p>
<p>或许可以设计一个<code>load_conda</code>的函数，然后需要用conda的时候加载它！</p>
<p>然而，这样好像太蠢了！有没有一个办法能够在我输入conda指令时，虽然引发了一个错误但自动加载conda环境，然后执行加载后的conda? （类似于虚拟内存与缺页中断）</p>
<p>我把激活conda相关的变量改成了这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.reddit.com/r/zsh/comments/qmd25q/lazy_loading_conda/</span></span><br><span class="line"><span class="comment"># Add any commands which depend on conda here</span></span><br><span class="line">lazy_conda_aliases=(<span class="string">&#x27;python&#x27;</span> <span class="string">&#x27;conda&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">load_conda</span></span>() &#123;</span><br><span class="line">  <span class="keyword">for</span> lazy_conda_alias <span class="keyword">in</span> <span class="variable">$lazy_conda_aliases</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">unalias</span> <span class="variable">$lazy_conda_alias</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">  __conda_prefix=<span class="string">&quot;<span class="variable">$HOME</span>/anaconda3&quot;</span> <span class="comment"># Set your conda Location</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># &gt;&gt;&gt; conda initialize &gt;&gt;&gt;</span></span><br><span class="line">  __conda_setup=<span class="string">&quot;<span class="subst">$(<span class="string">&quot;<span class="variable">$__conda_prefix</span>/bin/conda&quot;</span> &#x27;shell.bash&#x27; &#x27;hook&#x27; 2&gt; /dev/null)</span>&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$__conda_setup</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$__conda_prefix</span>/etc/profile.d/conda.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">          . <span class="string">&quot;<span class="variable">$__conda_prefix</span>/etc/profile.d/conda.sh&quot;</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$__conda_prefix</span>/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">unset</span> __conda_setup</span><br><span class="line">  <span class="comment"># &lt;&lt;&lt; conda initialize &lt;&lt;&lt;</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">unset</span> __conda_prefix</span><br><span class="line">  <span class="built_in">unfunction</span> load_conda</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> lazy_conda_alias <span class="keyword">in</span> <span class="variable">$lazy_conda_aliases</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">alias</span> <span class="variable">$lazy_conda_alias</span>=<span class="string">&quot;load_conda &amp;&amp; <span class="variable">$lazy_conda_alias</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>这个方案实在是太巧了！很符合我对未来的想象（</p>
<p>当你在shell输入conda时，没有加载conda时会触发load_conda，然后自动加载conda。之后又会被<code>alias</code>到conda指令本身，看起来就像无缝加载了一个变量一样！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/06/21/OS/MIT_6.S081/syscall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/21/OS/MIT_6.S081/syscall/" class="post-title-link" itemprop="url">xv6-syscall</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-21 17:47:19" itemprop="dateCreated datePublished" datetime="2022-06-21T17:47:19+08:00">2022-06-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT_6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="syscall">syscall</h1>
<h2 id="系统调用简介">系统调用简介</h2>
<p>系统调用<code>syscall</code>可以看作一次特殊的<code>函数调用</code>。程序按照<code>Calling Convention</code>将参数放在寄存器、堆栈中，然后CPU硬件修改程序计数器，权限状态等信息，跳转到内核提前设定好的一个位置（<code>stvec</code>）。</p>
<p>之后，处理器开始执行内核代码。内核代码执行完后，恢复发生中断时的现场，继续运行程序。</p>
<h2 id="syscall-lab-概述">syscall lab 概述</h2>
<p>这个<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/syscall.html">lab</a>一共有两个实验，分别是<code>trace</code>和<code>sysinfo</code>，前者要求我们在之后系统调用时，打印系统调用的情况，后者需要我们提供内存使用和进程的使用信息。</p>
<p>我的所有实验代码都可以在<a target="_blank" rel="noopener" href="https://github.com/inclyc/xv6-labs-2021/tree/syscall">github</a>找到。</p>
<h3 id="trace">trace</h3>
<p>这个实验重点是对于每个<code>proc</code>结构体保存一个flag，表示他要不要进行trace。</p>
<p>然后，在系统调用返回时，设计成可以打印结果:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">num = p-&gt;trapframe-&gt;a7;</span><br><span class="line"><span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">  <span class="type">int</span> ret = syscalls[num]();</span><br><span class="line">  p-&gt;trapframe-&gt;a0 = ret;</span><br><span class="line">  <span class="keyword">if</span> (p-&gt;tsysflag &amp; (<span class="number">1</span> &lt;&lt; num)) <span class="built_in">printf</span>(<span class="string">&quot;%d: %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscallnames[num], ret);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">          p-&gt;pid, p-&gt;name, num);</span><br></pre></td></tr></table></figure>
<p><code>tsysflag</code>是需要新写到结构体里的一个成员。</p>
<p><code>syscallnames</code>，每个系统调用的字符串名字。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *syscallnames[] = &#123;</span><br><span class="line">[SYS_fork]    <span class="string">&quot;fork&quot;</span>,</span><br><span class="line">[SYS_exit]    <span class="string">&quot;exit&quot;</span>,</span><br><span class="line">[SYS_wait]    <span class="string">&quot;wait&quot;</span>,</span><br><span class="line">[SYS_pipe]    <span class="string">&quot;pipe&quot;</span>,</span><br><span class="line">[SYS_read]    <span class="string">&quot;read&quot;</span>,</span><br><span class="line">[SYS_kill]    <span class="string">&quot;kill&quot;</span>,</span><br><span class="line">[SYS_exec]    <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">[SYS_fstat]   <span class="string">&quot;fstat&quot;</span>,</span><br><span class="line">[SYS_chdir]   <span class="string">&quot;chdir&quot;</span>,</span><br><span class="line">[SYS_dup]     <span class="string">&quot;dup&quot;</span>,</span><br><span class="line">[SYS_getpid]  <span class="string">&quot;getpid&quot;</span>,</span><br><span class="line">[SYS_sbrk]    <span class="string">&quot;sbrk&quot;</span>,</span><br><span class="line">[SYS_sleep]   <span class="string">&quot;sleep&quot;</span>,</span><br><span class="line">[SYS_uptime]  <span class="string">&quot;uptime&quot;</span>,</span><br><span class="line">[SYS_open]    <span class="string">&quot;open&quot;</span>,</span><br><span class="line">[SYS_write]   <span class="string">&quot;write&quot;</span>,</span><br><span class="line">[SYS_mknod]   <span class="string">&quot;mknod&quot;</span>,</span><br><span class="line">[SYS_unlink]  <span class="string">&quot;unlink&quot;</span>,</span><br><span class="line">[SYS_link]    <span class="string">&quot;link&quot;</span>,</span><br><span class="line">[SYS_mkdir]   <span class="string">&quot;mkdir&quot;</span>,</span><br><span class="line">[SYS_close]   <span class="string">&quot;close&quot;</span>,</span><br><span class="line">[SYS_trace]   <span class="string">&quot;trace&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>trace</code>实验的所有代码参考<a target="_blank" rel="noopener" href="https://github.com/inclyc/xv6-labs-2021/commit/082a7358cb69e5c0cef12117142c37e78a54d4b6?diff=split%60">这里</a>。</p>
<h3 id="sysinfo">sysinfo</h3>
<p>主要是实现两个模块，进程和内存。</p>
<p>内存方面，内核用一个<code>kfreelist</code>来保存现在空闲的内存信息，这是一个链表，统计时只需要遍历链表即可。内存都是按照页分配的，所以结果就是<code>PGSIZE * free_num</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kalloc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kfreepages_count</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> n = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">current</span> =</span> kmem.freelist;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(;current;current = current-&gt;next) ++n;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进程计数，直接遍历进程数组，看他们中哪些不是<code>UNUSED</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">nproc</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span>;</span></span><br><span class="line">  <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(p = proc;p &lt; proc + NPROC; p++)&#123;</span><br><span class="line">    acquire(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">if</span>(p-&gt;state != UNUSED) ret++;</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，整理出系统调用的结果，把他们拷贝到用户态去。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysinfo.c</span></span><br><span class="line">uint64 <span class="title function_">sys_sysinfo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  uint64 va_info;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>, &amp;va_info))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sysinfo</span> <span class="title">info</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  info.freemem = kfreepages_count() * PGSIZE;</span><br><span class="line">  info.nproc = nproc();</span><br><span class="line">  <span class="keyword">if</span>(copyout(p-&gt;pagetable, va_info, (<span class="type">void</span>*)&amp;info, <span class="keyword">sizeof</span>(info)))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/06/20/OS/MIT_6.S081/primes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/20/OS/MIT_6.S081/primes/" class="post-title-link" itemprop="url">xv6-util-primes</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 17:47:19" itemprop="dateCreated datePublished" datetime="2022-06-20T17:47:19+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT_6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="primes">Primes</h1>
<p>这个实验要求设计一个素数发生器。<a target="_blank" rel="noopener" href="https://swtch.com/~rsc/thread/">基于管道实现埃氏筛</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">produce</span><span class="params">(<span class="type">int</span> backward_pipe_fd)</span> &#123;</span><br><span class="line">  <span class="type">int</span> prime;</span><br><span class="line">  read(backward_pipe_fd, &amp;prime, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, prime);</span><br><span class="line">  <span class="keyword">if</span> (prime &gt;= <span class="number">31</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> pp[<span class="number">2</span>];</span><br><span class="line">  pipe(pp);</span><br><span class="line">  <span class="type">int</span> pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child</span></span><br><span class="line">    close(pp[<span class="number">1</span>]);</span><br><span class="line">    produce(pp[<span class="number">0</span>]);</span><br><span class="line">    close(pp[<span class="number">0</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    close(pp[<span class="number">0</span>]); <span class="comment">//  close a ----- b ----read--- c</span></span><br><span class="line">    <span class="keyword">for</span> (; read(backward_pipe_fd, &amp;n, <span class="keyword">sizeof</span>(<span class="type">int</span>));) &#123;</span><br><span class="line">      <span class="keyword">if</span> (n % prime)</span><br><span class="line">        write(pp[<span class="number">1</span>], &amp;n, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    close(pp[<span class="number">1</span>]);            <span class="comment">// close a ---------- b ---write-- c</span></span><br><span class="line">    close(backward_pipe_fd); <span class="comment">// close a ---read--- b ---------- c</span></span><br><span class="line">    wait(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prime 2\n&quot;</span>);</span><br><span class="line">  <span class="type">int</span> pp[<span class="number">2</span>];</span><br><span class="line">  pipe(pp);</span><br><span class="line">  <span class="type">int</span> pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child</span></span><br><span class="line">    close(pp[<span class="number">1</span>]);</span><br><span class="line">    produce(pp[<span class="number">0</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    close(pp[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">3</span>; i &lt; <span class="number">32</span>; i += <span class="number">2</span>) &#123;   <span class="comment">// filter 2-factors</span></span><br><span class="line">      write(pp[<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    close(pp[<span class="number">1</span>]);</span><br><span class="line">    wait(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/inclyc/xv6-labs-2021/commit/96d992511da523395b7984a78709315bb66f348a">最开始的实验版本</a>我在<code>fork</code>之后才调用<code>pipe</code>，导致出现了逻辑上的问题。这个程序中如果不及时关闭pipe中不需要的那个<code>fd</code>，会导致阻塞/资源用尽。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/06/20/OS/MIT_6.S081/pingpong/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/20/OS/MIT_6.S081/pingpong/" class="post-title-link" itemprop="url">xv6-util-pingpong</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 17:40:19" itemprop="dateCreated datePublished" datetime="2022-06-20T17:40:19+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT_6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pingpong">Pingpong</h1>
<p>继续Lab1的实验，这个程序要求我们用一个管道实现父子进程通信，即开一个pipe，然后父进程发一个ping，子进程表示自己收到了ping，然后再翻过来。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="type">int</span> pipes[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> n = pipe(pipes);</span><br><span class="line">  <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pipe error\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fork error\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">char</span> rd;</span><br><span class="line">    read(pipes[<span class="number">0</span>], &amp;rd, <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, getpid());</span><br><span class="line">    write(pipes[<span class="number">1</span>], &amp;rd, <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// parent process</span></span><br><span class="line">    <span class="type">char</span> wr = <span class="string">&#x27;p&#x27;</span>;</span><br><span class="line">    write(pipes[<span class="number">1</span>], &amp;wr, <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    read(pipes[<span class="number">0</span>], &amp;wr, <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, getpid());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/06/19/OS/MIT_6.S081/boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/19/OS/MIT_6.S081/boot/" class="post-title-link" itemprop="url">启动xv6</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 04:10:19" itemprop="dateCreated datePublished" datetime="2022-06-20T04:10:19+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT_6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="启动xv6easy">启动xv6(easy)</h1>
<h2 id="前言">前言</h2>
<p>我的实验环境是一台PC, 运行在我的寝室，作为工作站运行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[I] lyc@lyc-workstation ~/w/学/C/c/MIT6.S081 (master)&gt; neofetch</span><br><span class="line">         -/oyddmdhs+:.                lyc@lyc-workstation</span><br><span class="line">     -odNMMMMMMMMNNmhy+-`             -------------------</span><br><span class="line">   -yNMMMMMMMMMMMNNNmmdhy+-           OS: Gentoo Base System release 2.8 x86_64</span><br><span class="line"> `omMMMMMMMMMMMMNmdmmmmddhhy/`        Host: MS-7D42 1.0</span><br><span class="line"> omMMMMMMMMMMMNhhyyyohmdddhhhdo`      Kernel: 5.18.5-gentoo-lyc</span><br><span class="line">.ydMMMMMMMMMMdhs++so/smdddhhhhdm+`    Uptime: 22 hours, 29 mins</span><br><span class="line"> oyhdmNMMMMMMMNdyooydmddddhhhhyhNd.   Packages: 1473 (emerge)</span><br><span class="line">  :oyhhdNNMMMMMMMNNNmmdddhhhhhyymMh   Shell: bash 5.1.16</span><br><span class="line">    .:+sydNMMMMMNNNmmmdddhhhhhhmMmy   Resolution: 3840x2160</span><br><span class="line">       /mMMMMMMNNNmmmdddhhhhhmMNhs:   DE: Plasma 5.24.5</span><br><span class="line">    `oNMMMMMMMNNNmmmddddhhdmMNhs+`    WM: KWin</span><br><span class="line">  `sNMMMMMMMMNNNmmmdddddmNMmhs/.      WM Theme: Breeze 微风</span><br><span class="line"> /NMMMMMMMMNNNNmmmdddmNMNdso:`        Theme: Breeze Light [Plasma], Breeze [GTK2/3]</span><br><span class="line">+MMMMMMMNNNNNmmmmdmNMNdso/-           Icons: Fluent [Plasma], Fluent [GTK2/3]</span><br><span class="line">yMMNNNNNNNmmmmmNNMmhs+/-`             Terminal: Konsole</span><br><span class="line">/hMMNNNNNNNNMNdhs++/-`                CPU: 12th Gen Intel i7-12700 (20) @ 4.900GHz</span><br><span class="line">`/ohdmmddhys+++/:.`                   GPU: Intel AlderLake-S GT1</span><br><span class="line">  `-//////:--.                        Memory: 36679MiB / 128619MiB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="risc-v-64运行和交叉编译环境">RISC-V 64运行和交叉编译环境</h2>
<h3 id="cross-compilers">cross-compilers</h3>
<p>要运行老师给的<code>xv6</code>操作系统代码，必须先有交叉编译工具。<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/tools.html">[1]</a></p>
<p>用gentoo的crossdev工具<a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Cross_build_environment">[2]</a>安装跨指令集的编译工具，包括<code>GNU binutils</code>, <code>gcc</code>, <code>g++</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crossdev --stable -t riscv64-unknown-linux-gnu</span><br></pre></td></tr></table></figure>
<h3 id="emulatorqemu">Emulator(QEMU)</h3>
<p>安装打开了riscv64对应的编译开关的<code>qemu</code>，我的实验主机是<code>Gentoo Linux</code>操作系统，在<code>Portage</code>中加入<code>USE</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write-use app-emulation qemu qemu_user_targets_riscv64 qemu_softmmu_targets_riscv64</span><br></pre></td></tr></table></figure>
<p>其中<code>write-use</code>是一个自己写的辅助脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lyc@lyc-workstation ~&gt; <span class="built_in">cat</span> $(<span class="built_in">which</span> write-use)</span><br><span class="line"><span class="comment">#!/bin/fish</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> portage_use_dir <span class="string">&quot;/etc/portage/package.use&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$argv</span>[1]/<span class="variable">$argv</span>[2] <span class="variable">$argv</span>[3..]&quot;</span> | sudo <span class="built_in">tee</span> -a <span class="string">&quot;<span class="variable">$portage_use_dir</span>/<span class="variable">$argv</span>[1]&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后，重新编译qemu</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo emerge -av qemu</span><br></pre></td></tr></table></figure>
<h2 id="获取实验源代码">获取实验源代码</h2>
<h3 id="clone-mit-xv6仓库">clone mit xv6仓库</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://g.csail.mit.edu/xv6-labs-2021</span><br></pre></td></tr></table></figure>
<h3 id="选到util分支">选到util分支</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> xv6-labs-2021 &amp;&amp; git checkout util</span><br></pre></td></tr></table></figure>
<h2 id="编译和进入xv6系统">编译和进入xv6系统</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[I] lyc@lyc-workstation ~/w/学/C/c/M/xv6-labs-2021 (util)&gt; make qemu</span><br><span class="line">qemu-system-riscv64 -machine virt -bios none -kernel kernel/kernel -m 128M -smp 3 -nographic -drive file=fs.img,if=none,format=raw,id=x0 -device virtio-blk-device,drive=x0,bus=virtio-mmio-bus.0</span><br><span class="line"></span><br><span class="line">xv6 kernel is booting</span><br><span class="line"></span><br><span class="line">hart 1 starting</span><br><span class="line">hart 2 starting</span><br><span class="line">init: starting sh</span><br><span class="line">$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>Ctrl-a x</code>退出系统。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://inclyc.cn/2022/06/19/OS/MIT_6.S081/sleep/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="inclyc">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="inclyc">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | inclyc">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/06/19/OS/MIT_6.S081/sleep/" class="post-title-link" itemprop="url">xv6-util-sleep</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 04:10:19" itemprop="dateCreated datePublished" datetime="2022-06-20T04:10:19+08:00">2022-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-11-28 00:40:37" itemprop="dateModified" datetime="2022-11-28T00:40:37+08:00">2022-11-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/OS/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT_6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="sleep">sleep</h1>
<p>实现一个UNIX<code>sleep</code>程序，要求使用<code>sleep</code>系统调用。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/xv6/book-riscv-rev2.pdf">xv6 book</a> 第一章</li>
<li><code>user/</code>下有不少可以参考的程序</li>
<li>如果用户没有参数，则打印错误信息</li>
<li>用系统调用</li>
<li>系统调用源代码在<code>kernel/sysproc.c</code>中可见</li>
<li><code>main</code>函数应该使用<code>exit(0)</code>来正常推出</li>
<li>将程序写入到<code>Makefile</code>的UPROGS中。</li>
</ul>
<h2 id="构建系统添加sleep">构建系统添加sleep</h2>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">UPROGS=\</span><br><span class="line">	$U/_cat\</span><br><span class="line">	$U/_echo\</span><br><span class="line">	$U/_forktest\</span><br><span class="line">	$U/_grep\</span><br><span class="line">	$U/_init\</span><br><span class="line">	$U/_kill\</span><br><span class="line">	$U/_ln\</span><br><span class="line">	$U/_ls\</span><br><span class="line">	$U/_mkdir\</span><br><span class="line">	$U/_rm\</span><br><span class="line">	$U/_sh\</span><br><span class="line">	$U/_stressfs\</span><br><span class="line">	$U/_usertests\</span><br><span class="line">	$U/_grind\</span><br><span class="line">	$U/_wc\</span><br><span class="line">	$U/_zombie\</span><br><span class="line">	$U/_sleep\</span><br></pre></td></tr></table></figure>
<h2 id="sleep-syscall的实现">sleep syscall的实现</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line"></span><br><span class="line">uint64</span><br><span class="line"><span class="title function_">sys_sleep</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  uint ticks0;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">0</span>, &amp;n) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  acquire(&amp;tickslock);</span><br><span class="line">  ticks0 = ticks;</span><br><span class="line">  <span class="keyword">while</span>(ticks - ticks0 &lt; n)&#123;</span><br><span class="line">    <span class="keyword">if</span>(myproc()-&gt;killed)&#123;</span><br><span class="line">      release(&amp;tickslock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(&amp;ticks, &amp;tickslock);</span><br><span class="line">  &#125;</span><br><span class="line">  release(&amp;tickslock);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，这里的<code>sleep</code>函数是一个在<code>proc.c</code>中实现的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Atomically release lock and sleep on chan.</span></span><br><span class="line"><span class="comment">// Reacquires lock when awakened.</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">sleep</span><span class="params">(<span class="type">void</span> *chan, <span class="keyword">struct</span> spinlock *lk)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Must acquire p-&gt;lock in order to</span></span><br><span class="line">  <span class="comment">// change p-&gt;state and then call sched.</span></span><br><span class="line">  <span class="comment">// Once we hold p-&gt;lock, we can be</span></span><br><span class="line">  <span class="comment">// guaranteed that we won&#x27;t miss any wakeup</span></span><br><span class="line">  <span class="comment">// (wakeup locks p-&gt;lock),</span></span><br><span class="line">  <span class="comment">// so it&#x27;s okay to release lk.</span></span><br><span class="line"></span><br><span class="line">  acquire(&amp;p-&gt;lock);  <span class="comment">//DOC: sleeplock1</span></span><br><span class="line">  release(lk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Go to sleep.</span></span><br><span class="line">  p-&gt;chan = chan;</span><br><span class="line">  p-&gt;state = SLEEPING;</span><br><span class="line"></span><br><span class="line">  sched();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Tidy up.</span></span><br><span class="line">  p-&gt;chan = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Reacquire original lock.</span></span><br><span class="line">  release(&amp;p-&gt;lock);</span><br><span class="line">  acquire(lk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调度器、状态转移，这些概念应该在之后的课程中会涉及到。</p>
<h2 id="自己实现的sleep.c">自己实现的sleep.c</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/sleep.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: sleep &lt;seconds&gt;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> ticks = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">  sleep(ticks);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，他这里的<code>uint</code>还会出现一些编译错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In file included from user/sleep.c:1:</span><br><span class="line">user/user.h:36:1: 错误：unknown type name ‘uint’; did you mean ‘int’?</span><br><span class="line">   36 | uint strlen(const char*);</span><br><span class="line">      | ^~~~</span><br><span class="line">      | int</span><br><span class="line">user/user.h:37:26: 错误：unknown type name ‘uint’; did you mean ‘int’?</span><br><span class="line">   37 | void* memset(void*, int, uint);</span><br><span class="line">      |                          ^~~~</span><br><span class="line">      |                          int</span><br><span class="line">user/user.h:38:1: 错误：函数声明中出现形参名却未指定类型 [-Werror]</span><br><span class="line">   38 | void* malloc(uint);</span><br><span class="line">      | ^~~~</span><br><span class="line">user/user.h:41:40: 错误：unknown type name ‘uint’; did you mean ‘int’?</span><br><span class="line">   41 | int memcmp(const void *, const void *, uint);</span><br><span class="line">      |                                        ^~~~</span><br><span class="line">      |                                        int</span><br><span class="line">user/user.h:42:36: 错误：unknown type name ‘uint’; did you mean ‘int’?</span><br><span class="line">   42 | void *memcpy(void *, const void *, uint);</span><br><span class="line">      |                                    ^~~~</span><br><span class="line">      |                                    int</span><br><span class="line">cc1：所有的警告都被当作是错误</span><br></pre></td></tr></table></figure>
<p>我在<code>user/user.h</code>中加了一个类型定义，来解决这个编译错误</p>
<p>然后再次<code>make qemu</code>就可以了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">inclyc</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
